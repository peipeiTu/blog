{"componentChunkName":"component---src-templates-blog-post-js","path":"/notebook/database/transaction_and_lock/","result":{"data":{"markdownRemark":{"html":"<h5 id=\"äº‹åŠ¡transactionï¼š\" style=\"position:relative;\"><a href=\"#%E4%BA%8B%E5%8A%A1transaction%EF%BC%9A\" aria-label=\"äº‹åŠ¡transactionï¼š permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>äº‹åŠ¡(Transaction)ï¼š</h5>\n<ul>\n<li>äº‹åŠ¡æ˜¯æ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œç”±ä¸€ç³»åˆ—æœ‰é™çš„æ•°æ®åº“æ“ä½œåºåˆ—æ„æˆã€‚è¢«äº‹åŠ¡è£¹èµ·æ¥çš„è¿™äº›æ“ä½œä¼šæœ‰å…±åŒçš„æ‰§è¡Œç»“æœï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥å¹¶å…¨éƒ¨å›æ»šã€‚å¯ä»¥è§£å†³æ“ä½œåŸå­æ€§çš„é—®é¢˜ã€‚</li>\n</ul>\n<p>å¦‚é“¶è¡Œè½¬è´¦ï¼ŒAè½¬è´¦100ç»™Bï¼Œå³éœ€è¦ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">Aä½™é¢ <span class=\"token operator\">-</span><span class=\"token operator\">=</span> <span class=\"token number\">100</span>\nBä½™é¢ <span class=\"token operator\">+</span><span class=\"token operator\">=</span> <span class=\"token number\">100</span></code></pre></div>\n<p>ä¸¤æ¡è¯­å¥è™½ç„¶ç‹¬ç«‹ï¼Œä½†æœ€ç»ˆç»“æœå¿…é¡»æ˜¯è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">// SQLä»£ç </span>\n<span class=\"token keyword\">start</span> <span class=\"token keyword\">transaction</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// æ“ä½œ</span>\n<span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">Sequelize</code>æä¾›<code class=\"language-text\">Transaction</code>ç±»ï¼Œé€šè¿‡<code class=\"language-text\">Sequelize.transaction</code>åˆ›å»ºäº‹åŠ¡ï¼Œå¹¶åœ¨æ¯ä¸€æ¬¡æ•°æ®åº“æ“ä½œè®¾ç½®å½“å‰æ“ä½œå±äºå“ªä¸ªäº‹åŠ¡ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">await</span> sequelize<span class=\"token punctuation\">.</span><span class=\"token function\">transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">transaction</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Accounts<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    where<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      name<span class=\"token operator\">:</span> <span class=\"token string\">'name'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    transaction\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token keyword\">await</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    balances<span class=\"token operator\">:</span> instance<span class=\"token punctuation\">.</span>balances <span class=\"token operator\">+</span> number<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    transaction\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<hr>\n<h5 id=\"å¹¶å‘\" style=\"position:relative;\"><a href=\"#%E5%B9%B6%E5%8F%91\" aria-label=\"å¹¶å‘ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>å¹¶å‘</h5>\n<p>äº‹åŠ¡åªè§£å†³äº†æ“ä½œåŸå­æ€§çš„é—®é¢˜ï¼Œå¹¶å‘åˆ™éœ€è¦é€šè¿‡åŠ é”æ¥é¿å…ã€‚</p>\n<h6 id=\"é”ï¼š\" style=\"position:relative;\"><a href=\"#%E9%94%81%EF%BC%9A\" aria-label=\"é”ï¼š permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>é”ï¼š</h6>\n<ul>\n<li><code class=\"language-text\">æ‚²è§‚é”</code>ï¼šä¸ºäº†é¿å…å†²çªï¼Œç›´æ¥ç»™è®°å½•åŠ ä¸Šé”ï¼Œå†äº‹åŠ¡é‡Šæ”¾ä¹‹å‰ï¼Œå…¶ä»–è¦å¯¹è¯¥è®°å½•æ‰§è¡Œæ“ä½œçš„äº‹åŠ¡éƒ½å¿…é¡»ç­‰å¾…ã€‚MySqlã€Postgreséƒ½å®ç°äº†æ‚²è§‚é”ã€‚ç¼ºç‚¹æ˜¯ï¼Œå†è¯»æ“ä½œé¢‘ç¹çš„åœºæ™¯ä¸‹ï¼Œä¼šå½±å“ååé‡ã€‚</li>\n<li><code class=\"language-text\">ä¹è§‚é”</code>ï¼šä¸å¯¹è¯»è¿›è¡Œé™åˆ¶ï¼Œä»…åœ¨å†™å…¥æ›´æ–°çš„æ—¶å€™åšåˆ¤æ–­ã€‚é€šå¸¸ä¼šå¢åŠ versionå­—æ®µï¼Œæ¯æ¬¡æ›´æ–°çš„æ—¶å€™version+1ï¼Œæäº¤æ›´æ–°çš„æ—¶å€™å…ˆåˆ¤æ–­versionï¼Œå¦‚æœå·²å¤±æ•ˆåˆ™é‡è¯•ã€‚åœ¨å†™æ“ä½œé¢‘ç¹çš„åœºæ™¯ä¸‹ä¼šä¸æ–­å‘ç”Ÿé‡è¯•ï¼Œä¹Ÿä¼šå½±å“ååé‡ã€‚</li>\n<li><code class=\"language-text\">æ’ä»–é”</code>ï¼šæ‚²è§‚é”çš„ä¸€ç§ï¼ŒæŸ¥è¯¢çš„æ—¶å€™åŠ é”ã€‚åŒä¸€èµ„æºåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæ’ä»–é”ï¼Œå…¶ä»–äº‹åŠ¡è¯»å†™éƒ½éœ€è¦ç­‰å¾…ã€‚</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">// SQLä»£ç </span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> accounts <span class=\"token keyword\">WHERE</span> name<span class=\"token operator\">=</span><span class=\"token string\">'name'</span> <span class=\"token keyword\">FOR</span> <span class=\"token keyword\">UPDATE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Sequelize å†™æ³•</span>\n<span class=\"token keyword\">await</span> Accounts<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  where<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'name'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  lock<span class=\"token operator\">:</span> Sequelize<span class=\"token punctuation\">.</span>Transaction<span class=\"token punctuation\">.</span><span class=\"token constant\">LOCK</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UPDATE</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">å…±äº«é”</code>ï¼šå…è®¸åŒä¸€èµ„æºåŒæ—¶å­˜åœ¨å¤šä¸ªå…±äº«é”ï¼Œå½“éœ€è¦æ‰§è¡Œä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œæ—¶ï¼Œå¿…é¡»ç­‰å…¶ä»–æ‰€æœ‰å…±äº«é”éƒ½é‡Šæ”¾åæ‰èƒ½æ‰§è¡Œã€‚</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> accounts <span class=\"token keyword\">WHERE</span> name<span class=\"token operator\">=</span><span class=\"token string\">'name'</span> <span class=\"token keyword\">FOR</span> <span class=\"token keyword\">SHARE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">await</span> Accounts<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  where<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span><span class=\"token string\">'name'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  lock<span class=\"token operator\">:</span> Sequelize<span class=\"token punctuation\">.</span>Transaction<span class=\"token punctuation\">.</span><span class=\"token constant\">LOCK</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SHARE</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4 id=\"äº‹åŠ¡éš”ç¦»çº§\" style=\"position:relative;\"><a href=\"#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7\" aria-label=\"äº‹åŠ¡éš”ç¦»çº§ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>äº‹åŠ¡éš”ç¦»çº§</h4>\n<table class=\"table table-bordered table-striped table-dark\">\n  <thead>\n    <tr>\n      <th scope=\"col\">çº§åˆ«</th>\n      <th scope=\"col\">è„è¯»</th>\n      <th scope=\"col\">ä¸å¯é‡å¤è¯»</th>\n      <th scope=\"col\">å¹»è¯»</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th scope=\"row\">READ_UNCOMMITTED è¯»æœªæäº¤</th>\n      <td></td>\n      <td></td>\n      <td></td>\n    </tr>\n    <tr>\n      <th scope=\"row\">READ_COMMITTED è¯»å·²æäº¤</th>\n      <td>Ã—</td>\n      <td></td>\n      <td></td>\n    </tr>\n    <tr>\n      <th scope=\"row\">REPEATABLE_READ å¯é‡å¤è¯»</th>\n      <td>Ã—</td>\n      <td>Ã—</td>\n      <td></td>\n    </tr>\n        <tr>\n      <th scope=\"row\">SERIALIZABLE å¯ä¸²è¡ŒåŒ–</th>\n      <td>Ã—</td>\n      <td>Ã—</td>\n      <td>Ã—</td>\n    </tr>\n  </tbody>\n</table>\n<ul>\n<li>Ã—è¡¨ç¤ºåœ¨è¿™ä¸ªçº§åˆ«é‡Œï¼ŒæŸç±»é—®é¢˜ä¸ä¼šå‡ºç°ã€‚</li>\n</ul>\n<h6 id=\"ç›¸å…³æ–‡ç« \" style=\"position:relative;\"><a href=\"#%E7%9B%B8%E5%85%B3%E6%96%87%E7%AB%A0\" aria-label=\"ç›¸å…³æ–‡ç«  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ç›¸å…³æ–‡ç« </h6>\n<ul>\n<li><a href=\"https://juejin.im/post/5c98e31f51882574c6520dc3\">å­¦ç‚¹åç«¯çŸ¥è¯†ä¹‹ Sequelize ä¸­åˆ›å»ºäº‹åŠ¡å’ŒğŸ”</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<ul>\n<li><a href=\"/notebook/database/transaction_and_lock/#%E4%BA%8B%E5%8A%A1transaction%EF%BC%9A\">äº‹åŠ¡(Transaction)ï¼š</a></li>\n<li>\n<p><a href=\"/notebook/database/transaction_and_lock/#%E5%B9%B6%E5%8F%91\">å¹¶å‘</a></p>\n<ul>\n<li><a href=\"/notebook/database/transaction_and_lock/#%E9%94%81%EF%BC%9A\">é”ï¼š</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"/notebook/database/transaction_and_lock/#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7\">äº‹åŠ¡éš”ç¦»çº§</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"/notebook/database/transaction_and_lock/#%E7%9B%B8%E5%85%B3%E6%96%87%E7%AB%A0\">ç›¸å…³æ–‡ç« </a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"äº‹åŠ¡å’Œé”ï¼ˆåŒ…å«Sequelizeä¸‹çš„ä»£ç ï¼‰","date":"2019-12-09 06:09","description":"äº‹åŠ¡å’Œé”","type":"æ•°æ®åº“"}}},"pageContext":{"slug":"/notebook/database/transaction_and_lock/","previous":{"fields":{"slug":"/notebook/linux/expect/"},"frontmatter":{"title":"expectï¼šå®ç°è„šæœ¬çš„è‡ªåŠ¨äº¤äº’"}},"next":{"fields":{"slug":"/notebook/database/mysql_use/"},"frontmatter":{"title":"MySQLé…ç½®åŠä½¿ç”¨"}}}}}